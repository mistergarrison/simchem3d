
# Product Requirements Document (PRD)
## Project: MolNuSim (SimChem 3D)

### 1. Executive Summary
**SimChem 3D** is a high-fidelity, browser-based physics simulator that bridges the gap between Quantum Mechanics, Nuclear Physics, and Molecular Chemistry. It creates a continuous simulation environment where users can start from vacuum fluctuations (pair production), build quarks into hadrons, forge nuclei via neutron capture, and finally synthesize complex chemical molecules. The application runs on a custom physics engine built over HTML5 Canvas and React.

### 2. Game Modes & Progression
The application supports two distinct modes of operation:

#### 2.1 Sandbox Mode
*   **Access:** Instant access to all 118 elements, all Standard Model particles, and all molecular recipes.
*   **Goal:** Unrestricted experimentation and visualization.

#### 2.2 Discovery Mode (Progression)
*   **Concept:** A "Scientific RPG" progression where the user starts with nothing but the vacuum.
*   **Unlock Chain:**
    1.  **Vacuum Phase:** Use the **Energy Tool** to discover fundamental particles (Leptons, Quarks) via Pair Production.
    2.  **Hadron Phase:** Combine Quarks to discover Protons and Neutrons (Hadronization).
    3.  **Nuclear Phase:** Combine Nucleons to discover Elements (Hydrogen, Helium, etc.).
    4.  **Chemistry Phase:** Combine Elements to discover Molecules.
    5.  **Tool Unlocks:** 
        *   **Lasso Tool:** Unlocked after the first Molecule is discovered.
*   **Visual Feedback:** "Halo" effects on sidebar buttons indicate newly unlocked categories.

---

### 3. Physics Engine Architecture

The simulation runs on a dedicated loop (`SimulationEngine.ts`), decoupled from the React render cycle to ensure consistent 60 FPS performance.

#### 3.1 Integration Pipeline
*   **Method:** Semi-Implicit Euler integration.
*   **Sub-stepping:** 8 physics updates per render frame for stability.
*   **Force Accumulation:**
    1.  **Clear Forces:** Reset accumulators.
    2.  **Tools:** Apply Drag (Kinematic & Spring) and Auto-Rotation forces.
    3.  **Annealing:** Topology optimization and Valency enforcement.
    4.  **Interactions ($O(N^2)$):**
        *   **Coulomb:** Long-range electrostatics ($F = k q_1 q_2 / r^2$).
        *   **Reactions:** Modular checks for Annihilation, Positron Annihilation, Electron Capture, and Neutron Capture.
        *   **Short-Range:** Pauli Repulsion (Collision) and Bond Formation logic.
    5.  **Bond Physics:** Damped spring constraints for covalent bonds.
    6.  **VSEPR:** Angular restoration forces for molecular geometry.
    7.  **Z-Plane Restoration:** Weak force centering atoms on the focal plane.
    8.  **Integration:** Update Position/Velocity with Drag/Damping.

#### 3.2 Spawning & Clearance
*   **Clearance Phase:** When spawning a new entity, the engine creates a temporary "Repulsion Field" to push existing atoms away, clearing space to prevent explosive overlaps.
*   **Force-Directed Layout:** Molecule geometry is calculated instantly upon spawn using a mini-solver (`ForceDirectedLayout.ts`) that simulates repulsion and bond springs to find a valid 3D topology before injecting atoms into the main world.

---

### 4. Chemistry & Molecular Logic

#### 4.1 Bonding Rules
*   **Logic:** Defined in `BondingRules.ts`.
*   **Valency:** Hard caps based on group (e.g., C=4, N=3/5, O=2).
*   **Restrictions:**
    *   No Noble Gas bonding (except heavy Xe/Kr fluorides).
    *   No Metal-Hydrides (simplified).
    *   No 3-Membered Rings (Steric hindrance).

#### 4.2 VSEPR Geometry
The engine explicitly enforces 3D geometry based on Valence Shell Electron Pair Repulsion theory (`VSEPRSolver.ts`):
*   **Linear (180°):** 2 Domains (e.g., CO₂).
*   **Trigonal (120°):** 3 Domains (e.g., BF₃).
*   **Tetrahedral (109.5°):** 4 Domains (e.g., CH₄).
*   **Bent/Pyramidal:** Adjustments made for Lone Pairs (e.g., H₂O is ~104.5°).
*   **Dihedral/Twist:** Special forces applied to O-O and N-N bonds to prevent planar structures where lone pairs would clash.

#### 4.3 Annealing
The `AnnealingLogic` system runs periodically to "fix" user mistakes:
*   **Shedding:** Breaks weakest bonds if an atom exceeds valency.
*   **Optimization:** Replaces homonuclear bonds (like O-O) with stronger heteronuclear bonds (O-C) if available nearby.

---

### 5. Nuclear & Quantum Systems

#### 5.1 Standard Model Particles
*   **Quarks:** Up, Down, Charm, Strange, Top, Bottom (and anti-quarks).
*   **Leptons:** Electron, Muon, Tau, Neutrinos (and anti-leptons).
*   **Bosons:** Photon, Gluon, W/Z, Higgs.
*   **Mechanics:**
    *   **Boson Kinematics:** Photons (`γ`) and Gluons (`g`) act as massless projectiles. They spawn with `MAX_SPEED` in a random direction, ignore Drag, do not interact via Pauli Repulsion (ghosting), and are removed immediately upon exiting simulation bounds.
    *   **Pair Production:** Generated by the Energy Tool at specific energy thresholds (e.g., 1.022 MeV for e⁻/e⁺).
    *   **Annihilation:** Particle + Anti-Particle contact triggers explosion and removal.
    *   **Hadronization:** 3 Quarks within proximity merge into Baryons (uud → p⁺, udd → n).

#### 5.2 Nuclear Reactions
*   **Neutron Capture:** Neutron colliding with Nucleus increases Isotope Mass ($A \rightarrow A+1$). Can trigger instability.
*   **Electron Capture:** Electron colliding with Nucleus reduces Charge ($Z \rightarrow Z-1$).
*   **Decay:**
    *   **Modes:** Alpha, Beta-, Beta+, Electron Capture, Spontaneous Fission.
    *   **Implementation:** Probabilistic check based on Half-Life per frame.
    *   **Visuals:** Particle emission (e.g., Helium nucleus for Alpha) and recoil velocity.

---

### 6. Interface & Interaction

#### 6.1 Input Handling
*   **Unified Pointer System:** Handles Mouse and Touch seamlessly via `InputManager.ts`.
*   **Lasso Tool:** Draw polygon to select multiple atoms. Selection triggers "Assembly" logic to form molecules.
*   **Energy Tool:** Hold to charge up MeV. Release to spawn particle pairs. Target threshold logic with visual gauge.
*   **Throwing:** Velocity smoothing allows users to "fling" atoms.

#### 6.2 Visuals & Rendering
*   **View Modes:**
    *   **Glass:** Semitransparent gradients, internal volume visibility.
    *   **Solid:** Specular shading, distinct edges.
*   **Atom Visualization:**
    *   **Nucleons:** Small radius (r=20).
    *   **Atoms:** Large radius (r=30+), puffing up when electrons are captured.
    *   **Electrons:** Diffuse probability clouds.
*   **Feedback:**
    *   **Floating Labels:** Text labels identifying molecules (e.g., "Benzene") follow groups.
    *   **Effects:** Particle explosions, lightning arcs on launch, shimmer halos on unlock.

#### 6.3 UI Components
*   **Sidebar:** Palette management, Time slider, Tools.
*   **Periodic Table:** Full 118-element IUPAC grid.
*   **Standard Model Picker:** Grid of elementary particles.
*   **Recipe Picker:** Visual catalog of synthesizeable molecules.
*   **Help Modal:** Interactive guide adapting to Discovery state.

---

### 7. Technical Data Verification

#### 7.1 Unit Tests (`unitTests.ts`)
Validates static data integrity on startup:
*   Ensures all Isotopes have valid masses.
*   Ensures all Decay modes target existing elements.
*   Ensures all Molecular Recipes use existing elements and valid stoichiometry.

#### 7.2 System Tests (`systemTest.ts`)
An automated integration suite that runs on the live physics engine:
1.  **Pair Production:** Verify e⁻/e⁺ creation and annihilation.
2.  **Deuterium Chain:** Neutron capture (p + n → D) and Beta decay.
3.  **Hadronization:** Quark fusion into nucleons.
4.  **Ionic Water:** Formation of H₂O from ions.
5.  **Molecular Synthesis:** Layout and bonding of Benzene/Cyclohexane.
6.  **Decay Chain:** Observation of Superheavy element (Og) decay chain.

---

### 8. Immutable Laws (Hard Constraints)
1.  **Conservation of Charge:** Net charge must be preserved in reactions (e.g., Beta decay emits electron to balance proton creation).
2.  **Pauli Exclusion:** No two atoms can occupy the same space (enforced by stiff spring forces). *Exception: Bosons (Photons/Gluons) do not interact via Pauli forces.*
3.  **Speed Limit:** Terminal velocity clamp to prevent tunneling/simulation explosion. *Exception: Bosons are fixed at `MAX_SPEED`.*
4.  **Z-Bounds:** Atoms forced to stay within $\pm 10,000$ units on Z-axis to prevent loss.
